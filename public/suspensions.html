<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StudyLeave | ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="sidebar.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif; }
    .badge { padding: 4px 10px; border-radius: 9999px; font-weight: 700; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; }
    .card-hover:hover { transform: translateY(-1px); box-shadow: 0 10px 18px -14px rgba(0, 0, 0, 0.35); }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">
  <div class="flex">
    <!-- Sidebar -->
    <div id="sidebar-container"></div>

    <!-- Main content -->
    <div class="flex-1 min-h-screen">
      <!-- Top bar -->
      <header class="h-16 bg-white shadow flex items-center justify-between px-6">
        <div class="flex items-center gap-3 text-slate-500">
          <button class="lg:hidden text-xl">‚ò∞</button>
          <div class="flex items-center gap-2 text-sm">
            <a href="index.html" class="text-slate-400 hover:text-slate-600">Home</a>
            <span class="text-slate-300">/</span>
            <span class="font-semibold text-slate-700">Study Leave</span>
          </div>
        </div>
        <div class="flex items-center gap-3 text-slate-500">
          <div class="flex items-center gap-2 px-3 py-1 rounded-full border border-slate-200 bg-white">
            <span class="text-lg">üë§</span>
            <span id="auth-name" class="text-sm font-semibold text-slate-700">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
          </div>
          <button id="auth-logout" class="px-3 py-1 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </header>

      <main class="p-6 space-y-6">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div>
            <h1 class="text-2xl font-bold text-slate-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠</h1>
            <p class="text-sm text-slate-500">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠</p>
          </div>
        </div>

        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-100 space-y-4">
          <div class="flex flex-col lg:flex-row gap-3">
            <div class="flex-1">
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
                <input id="search-input" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á..." class="w-full pl-10 pr-3 py-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-100 focus:border-blue-400">
              </div>
            </div>
            <select id="year-filter" class="px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">
              <option value="all" selected>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            </select>
            <select id="status-filter" class="px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">
              <option value="all" selected>‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
              <option value="active">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
              <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
              <option value="completed">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
            </select>
          </div>
        </div>

        <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="text-sm text-slate-600">
            Show
            <select id="page-size" class="mx-2 px-2 py-1 rounded-lg border border-slate-200">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
            entries
          </div>
          <div id="page-info" class="text-sm text-slate-500"></div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-100 divide-y divide-slate-100" id="susp-container">
          <div class="px-6 py-3 grid grid-cols-12 text-xs font-semibold text-slate-500 uppercase tracking-wide">
            <div class="col-span-4">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</div>
            <div class="col-span-4">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
            <div class="col-span-2 text-right">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏≤</div>
            <div class="col-span-1 text-right">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div>
            <div class="col-span-1 text-right">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
          </div>
          <div id="susp-rows" class="divide-y divide-slate-100">
            <div class="px-6 py-6 text-sm text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
          </div>
        </div>
      </main>
    </div>
  </div>
  <script src="auth.js"></script>
  <script>
    const suspRows = document.getElementById('susp-rows');
    const BASE_API = 'api';
    const searchInput = document.getElementById('search-input');
    const yearFilter = document.getElementById('year-filter');
    const statusFilter = document.getElementById('status-filter');
    const pageSizeSelect = document.getElementById('page-size');
    const pageInfo = document.getElementById('page-info');
    let allLeaves = [];
    let filteredLeaves = [];
    let currentPage = 1;

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString('th-TH');
    }

    function statusBadge(status) {
      const map = {
        active: { text: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤', class: 'bg-blue-100 text-blue-700 border border-blue-200' },
        pending: { text: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', class: 'bg-amber-100 text-amber-700 border border-amber-200' },
        completed: { text: '‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤', class: 'bg-emerald-100 text-emerald-700 border border-emerald-200' },
      };
      const cfg = map[status] || { text: status || '-', class: 'bg-slate-100 text-slate-700 border border-slate-200' };
      return `<span class="badge ${cfg.class}">${cfg.text}</span>`;
    }

    function diffMonths(startDate, endDate) {
      if (!startDate || !endDate) return '-';
      const start = new Date(startDate);
      const end = new Date(endDate);
      if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return '-';
      let months = (end.getFullYear() - start.getFullYear()) * 12;
      months += end.getMonth() - start.getMonth();
      if (end.getDate() >= start.getDate()) {
        months += 1;
      }
      return months > 0 ? months : 0;
    }

    function splitPosition(text) {
      const raw = (text || '').trim();
      if (!raw) return { title: '', detail: '' };
      const parts = raw.split(/\r?\n+/).map(part => part.trim()).filter(Boolean);
      if (parts.length <= 1) return { title: raw, detail: '' };
      return { title: parts[0], detail: parts.slice(1).join(' ') };
    }

    function renderSuspensions(list) {
      if (!list || !list.length) {
        suspRows.innerHTML = `<div class="px-6 py-6 text-sm text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
        return;
      }

      suspRows.innerHTML = list.map(item => {
        const pos = splitPosition(item.position);
        return `
        <div class="px-6 py-4 grid grid-cols-12 items-center card-hover">
          <div class="col-span-4 min-w-0">
            <div class="font-semibold text-slate-800">${item.full_name || '-'}</div>
            <div class="text-sm text-slate-600 flex items-center gap-2 min-w-0">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100 text-xs font-semibold whitespace-nowrap">${pos.title || '-'}</span>
              ${pos.detail ? `<span class="text-slate-500 truncate" title="${pos.detail}">${pos.detail}</span>` : ''}
            </div>
          </div>
          <div class="col-span-4 min-w-0">
            <div class="font-semibold text-slate-800 truncate" title="${item.level || '-'}">${item.level || '-'}</div>
            <div class="text-xs text-slate-500 whitespace-nowrap">${item.type || ''}</div>
          </div>
          <div class="col-span-2 text-sm text-slate-700 whitespace-nowrap text-right">
            ${formatDate(item.start_date)} - ${formatDate(item.end_date)}
          </div>
          <div class="col-span-1 text-right font-semibold text-slate-900 whitespace-nowrap">
            ${diffMonths(item.start_date, item.end_date)}
          </div>
          <div class="col-span-1 text-right whitespace-nowrap">
            ${statusBadge(item.status)}
          </div>
        </div>
        `;
      }).join('');
    }

    function renderPagination() {
      const pageSize = Number(pageSizeSelect.value);
      const total = filteredLeaves.length;
      const totalPages = Math.max(Math.ceil(total / pageSize), 1);
      if (currentPage > totalPages) currentPage = totalPages;
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = Math.min(startIndex + pageSize, total);

      const pageItems = filteredLeaves.slice(startIndex, endIndex);
      renderSuspensions(pageItems);

      const showing = total === 0 ? 0 : startIndex + 1;
      pageInfo.textContent = `Showing ${showing} to ${endIndex} of ${total} entries`;

      renderPagerControls(totalPages);
    }

    function renderPagerControls(totalPages) {
      const existing = document.getElementById('pager');
      if (existing) existing.remove();

      const pager = document.createElement('div');
      pager.id = 'pager';
      pager.className = 'flex items-center justify-between bg-white rounded-xl p-4 shadow-sm border border-slate-100';

      const left = document.createElement('div');
      left.className = 'text-sm text-slate-500';
      left.textContent = totalPages > 1 ? '' : '';
      pager.appendChild(left);

      const controls = document.createElement('div');
      controls.className = 'flex items-center gap-2';

      const prev = document.createElement('button');
      prev.className = 'px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 disabled:opacity-50';
      prev.textContent = 'Previous';
      prev.disabled = currentPage === 1;
      prev.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage -= 1;
          renderPagination();
        }
      });
      controls.appendChild(prev);

      for (let i = 1; i <= totalPages; i += 1) {
        const btn = document.createElement('button');
        btn.className = i === currentPage
          ? 'px-3 py-2 rounded-lg bg-blue-600 text-white'
          : 'px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50';
        btn.textContent = i;
        btn.addEventListener('click', () => {
          currentPage = i;
          renderPagination();
        });
        controls.appendChild(btn);
      }

      const next = document.createElement('button');
      next.className = 'px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 disabled:opacity-50';
      next.textContent = 'Next';
      next.disabled = currentPage === totalPages;
      next.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage += 1;
          renderPagination();
        }
      });
      controls.appendChild(next);

      pager.appendChild(controls);

      const container = document.getElementById('susp-container');
      container.parentNode.insertBefore(pager, container.nextSibling);
    }

    function getFiscalYear(dateStr) {
      if (!dateStr) return null;
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) return null;
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      return month >= 10 ? year + 1 : year;
    }

    function buildYearOptions(list) {
      const years = new Set();
      list.forEach(item => {
        const fy = getFiscalYear(item.start_date);
        if (fy) years.add(fy);
      });
      const sorted = Array.from(years).sort((a, b) => b - a);
      yearFilter.innerHTML = '<option value="all">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
      sorted.forEach(year => {
        const option = document.createElement('option');
        option.value = String(year);
        option.textContent = `‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${year + 543}`;
        yearFilter.appendChild(option);
      });
    }

    function applyFilters() {
      const keyword = searchInput.value.trim().toLowerCase();
      const yearValue = yearFilter.value;
      const statusValue = statusFilter.value;

      filteredLeaves = allLeaves.filter(item => {
        const name = (item.full_name || '').toLowerCase();
        const position = (item.position || '').toLowerCase();
        const matchesKeyword = !keyword || name.includes(keyword) || position.includes(keyword);

        const fy = getFiscalYear(item.start_date);
        const matchesYear = yearValue === 'all' || (fy && String(fy) === yearValue);

        const status = item.status || '';
        const matchesStatus = statusValue === 'all' || status === statusValue;

        return matchesKeyword && matchesYear && matchesStatus;
      });
    }

    async function loadSuspensions() {
      suspRows.innerHTML = `<div class="px-6 py-6 text-sm text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;
      try {
        const res = await fetch(`${BASE_API}/leaves`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.data) {
          suspRows.innerHTML = `<div class="px-6 py-6 text-sm text-red-600">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
          return;
        }
        allLeaves = data.data;
        buildYearOptions(allLeaves);
        currentPage = 1;
        applyFilters();
        renderPagination();
      } catch (err) {
        suspRows.innerHTML = `<div class="px-6 py-6 text-sm text-red-600">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>`;
      }
    }

    searchInput.addEventListener('input', () => {
      currentPage = 1;
      applyFilters();
      renderPagination();
    });

    yearFilter.addEventListener('change', () => {
      currentPage = 1;
      applyFilters();
      renderPagination();
    });

    statusFilter.addEventListener('change', () => {
      currentPage = 1;
      applyFilters();
      renderPagination();
    });

    pageSizeSelect.addEventListener('change', () => {
      currentPage = 1;
      renderPagination();
    });

    document.addEventListener('DOMContentLoaded', () => {
      requireAuth();
      renderAuthStatus();
      loadSuspensions();
    });
  </script>
  <footer class="mt-10 border-t border-slate-200 bg-white">
    <div class="max-w-7xl mx-auto px-6 py-4 text-center text-xs text-slate-500">
      <div>Copyright ¬© 2026 by ‡∏™‡∏∏‡∏û‡∏à‡∏ô‡πå ‡∏™‡∏∏‡∏î‡∏™‡∏µ. All Rights Reserved.</div>
      <div>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ</div>
    </div>
  </footer>
</body>
</html>
